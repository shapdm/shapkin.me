<?xml version="1.0" encoding="utf-8" standalone="yes"?>
<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom" xmlns:media="http://search.yahoo.com/mrss/">
	<channel>
		<title>Posts on Заметки на полях</title>
		<link>https://shapkin.me/posts/</link>
		<description>Recent content in Posts on Заметки на полях</description>
		<generator>Hugo -- 0.145.0</generator>
		<language>en-us</language>
		<copyright>This work is licensed under a Creative Commons Attribution-NonCommercial 4.0 International License.</copyright>
		<lastBuildDate>Mon, 31 Mar 2025 18:24:40 +0300</lastBuildDate>
		<atom:link href="https://shapkin.me/posts/index.xml" rel="self" type="application/rss+xml" />
		
		
		<item>
			<title>Сборка OpenVPN с патчем XOR в Docker для Debian</title>
			<link>https://shapkin.me/posts/build-openvpn-with-xor-debian/</link>
			<pubDate>Thu, 27 Mar 2025 18:31:58 +0300</pubDate><guid>https://shapkin.me/posts/build-openvpn-with-xor-debian/</guid>
			<description><![CDATA[&lt;no value&gt;]]></description><content type="text/html" mode="escaped"><![CDATA[<p>Этим постом я открою цикл статей по сборке OpenVPN с патчем XOR, установке и настройке сервера OpenVPN.<br>
Полный список статей спрятан под спойлер.</p>

<details>
  <summary>Список статей</summary>
  <ol>
<li><a href="/posts/build-openvpn-with-xor-debian/">Сборка OpenVPN с патчем XOR в Docker для Debian</a></li>
<li><a href="/posts/build-openvpn-with-xor-windows/">Сборка OpenVPN с патчем XOR в Docker для Windows</a></li>
<li><a href="/posts/build-openvpn-with-xor-android/">Сборка OpenVPN с патчем XOR в Docker для Android</a></li>
<li><a href="/posts/openvpn-server-setup/">Настройка сервера OpenVPN</a></li>
</ol>
</details>

<p>Соберем deb пакет для Debian 12 и скопируем его на хостовую машину, чтобы использовать для установки на других системах.
Первым делом, создаем директорию, в которой будут все наши конфиги:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">mkdir openvpn
</span></span></code></pre></div><p>Теперь переходим в нее и создаем файлы, указанные ниже.</p>
<h3 id="dockerfile">Dockerfile<a href="#dockerfile" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="ln"> 1</span><span class="cl">FROM debian:12
</span></span><span class="line"><span class="ln"> 2</span><span class="cl">
</span></span><span class="line"><span class="ln"> 3</span><span class="cl"><span class="c1"># Создаем volume</span>
</span></span><span class="line"><span class="ln"> 4</span><span class="cl">VOLUME /release
</span></span><span class="line"><span class="ln"> 5</span><span class="cl">
</span></span><span class="line"><span class="ln"> 6</span><span class="cl"><span class="c1"># Устанавливаем необходимые пакеты</span>
</span></span><span class="line"><span class="ln"> 7</span><span class="cl">RUN apt-get update <span class="o">&amp;&amp;</span> <span class="se">\
</span></span></span><span class="line"><span class="ln"> 8</span><span class="cl"><span class="se"></span>    apt-get install -y git <span class="se">\
</span></span></span><span class="line"><span class="ln"> 9</span><span class="cl"><span class="se"></span>    gcc <span class="se">\
</span></span></span><span class="line"><span class="ln">10</span><span class="cl"><span class="se"></span>    libssl-dev <span class="se">\
</span></span></span><span class="line"><span class="ln">11</span><span class="cl"><span class="se"></span>    liblzo2-dev <span class="se">\
</span></span></span><span class="line"><span class="ln">12</span><span class="cl"><span class="se"></span>    liblz4-dev <span class="se">\
</span></span></span><span class="line"><span class="ln">13</span><span class="cl"><span class="se"></span>    libpam0g-dev <span class="se">\
</span></span></span><span class="line"><span class="ln">14</span><span class="cl"><span class="se"></span>    make <span class="se">\
</span></span></span><span class="line"><span class="ln">15</span><span class="cl"><span class="se"></span>    unzip <span class="se">\
</span></span></span><span class="line"><span class="ln">16</span><span class="cl"><span class="se"></span>    sbuild <span class="se">\
</span></span></span><span class="line"><span class="ln">17</span><span class="cl"><span class="se"></span>    build-essential <span class="se">\
</span></span></span><span class="line"><span class="ln">18</span><span class="cl"><span class="se"></span>    debhelper <span class="se">\
</span></span></span><span class="line"><span class="ln">19</span><span class="cl"><span class="se"></span>    fakeroot <span class="se">\
</span></span></span><span class="line"><span class="ln">20</span><span class="cl"><span class="se"></span>    devscripts <span class="se">\
</span></span></span><span class="line"><span class="ln">21</span><span class="cl"><span class="se"></span>    pkg-config <span class="se">\
</span></span></span><span class="line"><span class="ln">22</span><span class="cl"><span class="se"></span>    dpkg-dev <span class="se">\
</span></span></span><span class="line"><span class="ln">23</span><span class="cl"><span class="se"></span>    libpkcs11-helper-dev <span class="se">\
</span></span></span><span class="line"><span class="ln">24</span><span class="cl"><span class="se"></span>    libselinux1-dev <span class="se">\
</span></span></span><span class="line"><span class="ln">25</span><span class="cl"><span class="se"></span>    libcap-ng-dev <span class="se">\
</span></span></span><span class="line"><span class="ln">26</span><span class="cl"><span class="se"></span>    libnl-3-dev <span class="se">\
</span></span></span><span class="line"><span class="ln">27</span><span class="cl"><span class="se"></span>    libnl-genl-3-dev
</span></span><span class="line"><span class="ln">28</span><span class="cl">
</span></span><span class="line"><span class="ln">29</span><span class="cl"><span class="c1"># Создаем рабочую директорию</span>
</span></span><span class="line"><span class="ln">30</span><span class="cl">WORKDIR /openvpn-build
</span></span><span class="line"><span class="ln">31</span><span class="cl">
</span></span><span class="line"><span class="ln">32</span><span class="cl"><span class="c1"># Скачиваем исходный код OpenVPN</span>
</span></span><span class="line"><span class="ln">33</span><span class="cl">RUN wget https://github.com/OpenVPN/openvpn/releases/download/v2.6.13/openvpn-2.6.13.tar.gz <span class="o">&amp;&amp;</span> <span class="se">\
</span></span></span><span class="line"><span class="ln">34</span><span class="cl"><span class="se"></span>    tar -xzf openvpn-2.6.13.tar.gz 
</span></span><span class="line"><span class="ln">35</span><span class="cl">
</span></span><span class="line"><span class="ln">36</span><span class="cl"><span class="c1"># Копируем настройки и скрипт сборки</span>
</span></span><span class="line"><span class="ln">37</span><span class="cl">WORKDIR /openvpn-build/openvpn-2.6.13
</span></span><span class="line"><span class="ln">38</span><span class="cl">COPY ./debian debian
</span></span><span class="line"><span class="ln">39</span><span class="cl">COPY ./entrypoint.sh /entrypoint.sh
</span></span><span class="line"><span class="ln">40</span><span class="cl">
</span></span><span class="line"><span class="ln">41</span><span class="cl"><span class="c1"># Делаем исполняемым</span>
</span></span><span class="line"><span class="ln">42</span><span class="cl">RUN chmod +x /entrypoint.sh
</span></span><span class="line"><span class="ln">43</span><span class="cl">
</span></span><span class="line"><span class="ln">44</span><span class="cl">ENTRYPOINT <span class="o">[</span><span class="s2">&#34;bash&#34;</span>, <span class="s2">&#34;-ex&#34;</span>, <span class="s2">&#34;/entrypoint.sh&#34;</span><span class="o">]</span>
</span></span></code></pre></div><h3 id="entrypointsh">entrypoint.sh<a href="#entrypointsh" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="cp">#!/bin/bash
</span></span></span><span class="line"><span class="ln"> 2</span><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="ln"> 3</span><span class="cl"><span class="nb">set</span> -euo pipefail
</span></span><span class="line"><span class="ln"> 4</span><span class="cl">
</span></span><span class="line"><span class="ln"> 5</span><span class="cl"><span class="nv">OVPN_VERSION</span><span class="o">=</span><span class="s2">&#34;2.6.13&#34;</span>
</span></span><span class="line"><span class="ln"> 6</span><span class="cl">
</span></span><span class="line"><span class="ln"> 7</span><span class="cl"><span class="nb">cd</span> /openvpn-build/openvpn-<span class="nv">$OVPN_VERSION</span>
</span></span><span class="line"><span class="ln"> 8</span><span class="cl">
</span></span><span class="line"><span class="ln"> 9</span><span class="cl"><span class="c1"># Скачиваем и применяем XOR patch</span>
</span></span><span class="line"><span class="ln">10</span><span class="cl">mkdir -p patches <span class="o">&amp;&amp;</span> <span class="se">\
</span></span></span><span class="line"><span class="ln">11</span><span class="cl"><span class="se"></span>    <span class="nb">cd</span> patches <span class="o">&amp;&amp;</span> <span class="se">\
</span></span></span><span class="line"><span class="ln">12</span><span class="cl"><span class="se"></span>    wget -q https://raw.githubusercontent.com/Tunnelblick/Tunnelblick/master/third_party/sources/openvpn/openvpn-<span class="nv">$OVPN_VERSION</span>/patches/02-tunnelblick-openvpn_xorpatch-a.diff -O 02-tunnelblick-openvpn_xorpatch-a.diff <span class="o">&amp;&amp;</span> <span class="se">\
</span></span></span><span class="line"><span class="ln">13</span><span class="cl"><span class="se"></span>    wget -q https://raw.githubusercontent.com/Tunnelblick/Tunnelblick/master/third_party/sources/openvpn/openvpn-<span class="nv">$OVPN_VERSION</span>/patches/03-tunnelblick-openvpn_xorpatch-b.diff -O 03-tunnelblick-openvpn_xorpatch-b.diff <span class="o">&amp;&amp;</span> <span class="se">\
</span></span></span><span class="line"><span class="ln">14</span><span class="cl"><span class="se"></span>    wget -q https://raw.githubusercontent.com/Tunnelblick/Tunnelblick/master/third_party/sources/openvpn/openvpn-<span class="nv">$OVPN_VERSION</span>/patches/04-tunnelblick-openvpn_xorpatch-c.diff -O 04-tunnelblick-openvpn_xorpatch-c.diff <span class="o">&amp;&amp;</span> <span class="se">\
</span></span></span><span class="line"><span class="ln">15</span><span class="cl"><span class="se"></span>    wget -q https://raw.githubusercontent.com/Tunnelblick/Tunnelblick/master/third_party/sources/openvpn/openvpn-<span class="nv">$OVPN_VERSION</span>/patches/05-tunnelblick-openvpn_xorpatch-d.diff -O 05-tunnelblick-openvpn_xorpatch-d.diff <span class="o">&amp;&amp;</span> <span class="se">\
</span></span></span><span class="line"><span class="ln">16</span><span class="cl"><span class="se"></span>    wget -q https://raw.githubusercontent.com/Tunnelblick/Tunnelblick/master/third_party/sources/openvpn/openvpn-<span class="nv">$OVPN_VERSION</span>/patches/06-tunnelblick-openvpn_xorpatch-e.diff -O 06-tunnelblick-openvpn_xorpatch-e.diff
</span></span><span class="line"><span class="ln">17</span><span class="cl">
</span></span><span class="line"><span class="ln">18</span><span class="cl"><span class="c1"># Применяем патчи</span>
</span></span><span class="line"><span class="ln">19</span><span class="cl"><span class="nb">cd</span> /openvpn-build/openvpn-<span class="nv">$OVPN_VERSION</span>
</span></span><span class="line"><span class="ln">20</span><span class="cl">
</span></span><span class="line"><span class="ln">21</span><span class="cl"><span class="k">for</span> patch in patches/*.diff<span class="p">;</span> <span class="k">do</span> 
</span></span><span class="line"><span class="ln">22</span><span class="cl">	patch -p1 &lt; <span class="s2">&#34;</span><span class="nv">$patch</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="ln">23</span><span class="cl"><span class="k">done</span>
</span></span><span class="line"><span class="ln">24</span><span class="cl">
</span></span><span class="line"><span class="ln">25</span><span class="cl"><span class="c1"># Правим аттрибуты</span>
</span></span><span class="line"><span class="ln">26</span><span class="cl">chmod -R <span class="m">644</span> debian/*
</span></span><span class="line"><span class="ln">27</span><span class="cl">chmod <span class="m">755</span> debian/rules
</span></span><span class="line"><span class="ln">28</span><span class="cl">
</span></span><span class="line"><span class="ln">29</span><span class="cl"><span class="c1"># Запуск сборки</span>
</span></span><span class="line"><span class="ln">30</span><span class="cl">dpkg-buildpackage -us -uc
</span></span><span class="line"><span class="ln">31</span><span class="cl">
</span></span><span class="line"><span class="ln">32</span><span class="cl"><span class="c1"># Копируем собранный deb пакет на хост</span>
</span></span><span class="line"><span class="ln">33</span><span class="cl">cp /openvpn-build/openvpn_*.deb /release
</span></span><span class="line"><span class="ln">34</span><span class="cl">
</span></span><span class="line"><span class="ln">35</span><span class="cl"><span class="c1"># Очищаем ненужные файлы</span>
</span></span><span class="line"><span class="ln">36</span><span class="cl">apt-get clean <span class="o">&amp;&amp;</span> rm -rf /var/lib/apt/lists/* /tmp/* /var/tmp/*
</span></span></code></pre></div><p>Создаем папки release и debian</p>
<pre tabindex="0"><code>mkdir {release,debian}
</code></pre><p>В папке debian нужно создать файлы с конфигурацией для сборки, приведу свои варианты.</p>
<p>Кратко опишу для чего каждый файл:</p>
<table>
  <thead>
      <tr>
          <th>Имя файла</th>
          <th>Описание</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td><strong>Changelog</strong></td>
          <td>Описывает всю историю изменений</td>
      </tr>
      <tr>
          <td><strong>Compat</strong></td>
          <td>Указывает уровень совместимости с debhelper</td>
      </tr>
      <tr>
          <td><strong>Control</strong></td>
          <td>Содержит всю основную информацию о собираемом пакете</td>
      </tr>
      <tr>
          <td><strong>Rules</strong></td>
          <td>Описывает правила по которым будет происходить компиляции пакета</td>
      </tr>
      <tr>
          <td><strong>Copyright</strong></td>
          <td>Содержит информацию об авторских правах и лицензии исходников</td>
      </tr>
  </tbody>
</table>
<p>Подробнее с форматом можно ознакомиться по ссылке: <a href="https://www.debian.org/doc/manuals/maint-guide/dreq.ru.html" target="_blank">https://www.debian.org/doc/manuals/maint-guide/dreq.ru.html</a></p>
<h3 id="debianchangelog">debian/changelog<a href="#debianchangelog" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">openvpn <span class="o">(</span>2.6.13<span class="o">)</span> unstable<span class="p">;</span> <span class="nv">urgency</span><span class="o">=</span>medium
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  * Custom build with XOR patch <span class="k">for</span> Tunnelblick
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  -- Your Name &lt;your@mail&gt;  Thu, <span class="m">01</span> Jan <span class="m">1970</span> 00:00:00 +0000
</span></span></code></pre></div><h3 id="debiancompat">debian/compat<a href="#debiancompat" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="m">12</span>
</span></span></code></pre></div><h3 id="debiancontrol">debian/control<a href="#debiancontrol" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">Source: openvpn
</span></span><span class="line"><span class="cl">Section: net
</span></span><span class="line"><span class="cl">Priority: optional
</span></span><span class="line"><span class="cl">Maintainer: ShDm &lt;shdmw@yandex.ru&gt;
</span></span><span class="line"><span class="cl">Build-Depends: debhelper <span class="o">(</span>&gt;<span class="o">=</span> 12<span class="o">)</span>, libssl-dev, liblz4-dev, libpkcs11-helper-dev, libpam0g-dev, libselinux1-dev, libcap-ng-dev
</span></span><span class="line"><span class="cl">Standards-Version: 2.6.13
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Package: openvpn
</span></span><span class="line"><span class="cl">Architecture: any
</span></span><span class="line"><span class="cl">Depends: <span class="si">${</span><span class="nv">shlibs</span><span class="p">:</span><span class="nv">Depends</span><span class="si">}</span>, <span class="si">${</span><span class="nv">misc</span><span class="p">:</span><span class="nv">Depends</span><span class="si">}</span>
</span></span><span class="line"><span class="cl">Recommends: easy-rsa
</span></span><span class="line"><span class="cl">Suggests: openssl, resolvconf, openvpn-dco-dkms, openvpn-systemd-resolved
</span></span><span class="line"><span class="cl">Homepage: https://openvpn.net/
</span></span><span class="line"><span class="cl">Description: OpenVPN with XOR
</span></span><span class="line"><span class="cl"> Custom OpenVPN build with XOR patch from Tunnelblick
</span></span></code></pre></div><h3 id="debiancopyright">debian/copyright<a href="#debiancopyright" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">Format: https://www.debian.org/doc/packaging-manuals/copyright-format/1.0/
</span></span><span class="line"><span class="cl">Upstream-Name: OpenVPN
</span></span><span class="line"><span class="cl">Source: https://github.com/OpenVPN/openvpn
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Files: *
</span></span><span class="line"><span class="cl">Copyright: 2001-2023 OpenVPN Inc.
</span></span><span class="line"><span class="cl">License: GPL-2+
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">License: GPL-2+
</span></span><span class="line"><span class="cl"> This program is free software<span class="p">;</span> you can redistribute it and/or modify
</span></span><span class="line"><span class="cl"> it under the terms of the GNU General Public License as published by
</span></span><span class="line"><span class="cl"> the Free Software Foundation<span class="p">;</span> either version <span class="m">2</span> of the License, or
</span></span><span class="line"><span class="cl"> <span class="o">(</span>at your option<span class="o">)</span> any later version.
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"> This program is distributed in the hope that it will be useful,
</span></span><span class="line"><span class="cl"> but WITHOUT ANY WARRANTY<span class="p">;</span> without even the implied warranty of
</span></span><span class="line"><span class="cl"> MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
</span></span><span class="line"><span class="cl"> GNU General Public License <span class="k">for</span> more details.
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"> You should have received a copy of the GNU General Public License along
</span></span><span class="line"><span class="cl"> with this program<span class="p">;</span> <span class="k">if</span> not, write to the Free Software Foundation, Inc.,
</span></span><span class="line"><span class="cl"> <span class="m">51</span> Franklin Street, Fifth Floor, Boston, MA 02110-1301 USA.
</span></span></code></pre></div><h3 id="debianrules">debian/rules<a href="#debianrules" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="cp">#!/usr/bin/make -f
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl">%:
</span></span><span class="line"><span class="cl">	dh <span class="nv">$@</span>
</span></span></code></pre></div><p>Теперь запускаем и ждем выполнения, процесс может быть долгим, все зависит от характеристик оборудования, на котором запускается сборка.
Сперва соберем наш образ:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">docker build -t openvpn-build-debian .
</span></span></code></pre></div><p>После успешной сборки запускаем контейнер, внутри которого уже соберется deb пакет:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">docker run --rm --name openvpn-release-debian -v <span class="k">$(</span><span class="nb">pwd</span><span class="k">)</span>/release:/release openvpn-build-debian
</span></span></code></pre></div><p>Если ошибок в конце нет, значит все прошло успешно и собранный deb пакет должен находиться в папке <code>release</code>, а контейнер будет удален, так как мы запустили сборку с флагом <code>--rm</code>.</p>
<p>Информацию о собранном пакете можем проверить командой:</p>
<pre tabindex="0"><code>apt info ./release/openvpn_2.6.13_amd64.deb
</code></pre><p>Вывод будет примерно таким:</p>
<pre tabindex="0"><code>Package: openvpn
Version: 2.6.13
Priority: optional
Section: net
Maintainer: Your Name &lt;your@mail&gt;
Installed-Size: 1,177 kB
Depends: libc6 (&gt;= 2.34), libcap-ng0 (&gt;= 0.7.9), liblz4-1 (&gt;= 0.0~r130), liblzo2-2 (&gt;= 2.02), libnl-3-200 (&gt;= 3.2.7), libnl-genl-3-200 (&gt;= 3.2.7), libpam0g (&gt;= 0.99.7.1), libssl3 (&gt;= 3.0.0)
Recommends: easy-rsa
Suggests: openssl, resolvconf, openvpn-dco-dkms, openvpn-systemd-resolved
Homepage: https://openvpn.net/
Download-Size: 522 kB
APT-Sources: /opt/openvpn/release/openvpn_2.6.13_amd64.deb
Description: OpenVPN with XOR
 Custom OpenVPN build with XOR patch from Tunnelblick
</code></pre><p>Теперь собранный пакет можно использовать для установки.
Нужно учесть, что для обновления версии потребуется заново производить сборку и важно, чтобы под желаемую версию OpenVPN уже существовали актуальные патчи от Tunnelblick.</p>
<p><strong>Исходники OpenVPN:</strong><br>
<a href="https://github.com/OpenVPN/openvpn" target="_blank">https://github.com/OpenVPN/openvpn</a><br>
<strong>Исходники патчей Tunnelblick:</strong><br>
<a href="https://github.com/Tunnelblick/Tunnelblick/tree/master/third_party/sources/openvpn" target="_blank">https://github.com/Tunnelblick/Tunnelblick/tree/master/third_party/sources/openvpn</a></p>
]]></content>
		</item>
		
		<item>
			<title>Как настроить мониторинг срока действия доменов с помощью Grafana и Prometheus</title>
			<link>https://shapkin.me/posts/domain-expiration-days-grafana/</link>
			<pubDate>Wed, 26 Mar 2025 18:20:02 +0300</pubDate><guid>https://shapkin.me/posts/domain-expiration-days-grafana/</guid>
			<description><![CDATA[&lt;no value&gt;]]></description><content type="text/html" mode="escaped"><![CDATA[<p>В этой статье я расскажу, как добавить в систему мониторинга на базе Grafana и Prometheus проверку срока действия домена.
Мы будем использовать простой Bash-скрипт для проверки даты истечения доменов, Pushgateway для передачи данных в Prometheus и Grafana для визуализации результатов, а все сервисы будут упакованы в docker контейнеры.</p>
<p>Установку и настройку <code>prometheus</code> и <code>grafana</code> в этом посте рассматривать не будем, предполагается, что они уже установлены.</p>
<h3 id="общая-логика-работы">Общая логика работы<a href="#%d0%be%d0%b1%d1%89%d0%b0%d1%8f-%d0%bb%d0%be%d0%b3%d0%b8%d0%ba%d0%b0-%d1%80%d0%b0%d0%b1%d0%be%d1%82%d1%8b" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h3>
<p>Система состоит из нескольких компонентов:</p>
<p><strong>Bash-скрипт (check_domains.sh)</strong>: Проверяет срок действия доменов через whois и отправляет данные в Pushgateway.<br>
<strong>Pushgateway</strong>: Промежуточный сервис для отправки метрик в Prometheus.<br>
<strong>Prometheus</strong>: Собирает метрики из Pushgateway.<br>
<strong>Grafana</strong>: Визуализирует данные в виде графиков и панелей.</p>
<p>Работает это так:</p>
<p>Скрипт запускается по расписанию через cron.
Он получает дату истечения домена через whois, вычисляет количество дней до истечения и отправляет эти данные в Pushgateway.
Prometheus периодически собирает данные из Pushgateway.
В Grafana создаем dashboard для отображения данных в подходящем виде.</p>
<p>Для установки <code>Pushgateway</code> нужно прописать в <code>docker-compose</code> файле:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">  pushgateway:
</span></span><span class="line"><span class="cl">    image: prom/pushgateway
</span></span><span class="line"><span class="cl">    container_name: pushgateway
</span></span><span class="line"><span class="cl">    network_mode: host
</span></span><span class="line"><span class="cl">    ports:
</span></span><span class="line"><span class="cl">      - <span class="s2">&#34;9091:9091&#34;</span> <span class="c1"># Порт Pushgateway</span>
</span></span></code></pre></div><p>Также, нужно сообщить <code>Prometheus</code> откуда брать данные, для этого в prometheus.yml пропишем:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">  - job_name: <span class="s2">&#34;pushgateway&#34;</span>
</span></span><span class="line"><span class="cl">    honor_labels: <span class="nb">true</span>
</span></span><span class="line"><span class="cl">    static_configs:
</span></span><span class="line"><span class="cl">	  - targets: <span class="o">[</span><span class="s1">&#39;prometheus:9091&#39;</span><span class="o">]</span>
</span></span></code></pre></div><h3 id="код-скрипта-check_domainssh">Код скрипта check_domains.sh<a href="#%d0%ba%d0%be%d0%b4-%d1%81%d0%ba%d1%80%d0%b8%d0%bf%d1%82%d0%b0-check_domainssh" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="cp">#!/bin/bash
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="nb">set</span> -euo pipefail
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nv">LOG_FILE</span><span class="o">=</span><span class="s2">&#34;/var/log/check-domains.log&#34;</span>
</span></span><span class="line"><span class="cl"><span class="nv">PUSHGATEWAY_URL</span><span class="o">=</span><span class="s2">&#34;http://localhost:9091&#34;</span>
</span></span><span class="line"><span class="cl"><span class="nv">DOMAINS</span><span class="o">=(</span><span class="s2">&#34;aaa.ru&#34;</span> <span class="s2">&#34;bbb.ru&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Проверка наличия необходимых утилит</span>
</span></span><span class="line"><span class="cl"><span class="k">for</span> cmd in whois curl<span class="p">;</span> <span class="k">do</span>
</span></span><span class="line"><span class="cl">    <span class="nb">command</span> -v <span class="s2">&#34;</span><span class="nv">$cmd</span><span class="s2">&#34;</span> &gt;/dev/null <span class="o">||</span> <span class="o">{</span> <span class="nb">echo</span> <span class="s2">&#34;Error: </span><span class="nv">$cmd</span><span class="s2"> is not installed.&#34;</span> <span class="p">|</span> tee -a <span class="s2">&#34;</span><span class="nv">$LOG_FILE</span><span class="s2">&#34;</span><span class="p">;</span> <span class="nb">exit</span> 1<span class="p">;</span> <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="k">done</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Функция для получения и отправки данных</span>
</span></span><span class="line"><span class="cl">process_domain<span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="nb">local</span> <span class="nv">domain</span><span class="o">=</span><span class="nv">$1</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># Получение даты истечения через whois</span>
</span></span><span class="line"><span class="cl">    <span class="nv">expiration_date</span><span class="o">=</span><span class="k">$(</span>whois <span class="s2">&#34;</span><span class="nv">$domain</span><span class="s2">&#34;</span> <span class="p">|</span> grep -i <span class="s2">&#34;expiry date&#34;</span> <span class="p">|</span> awk <span class="s1">&#39;{print $4}&#39;</span> <span class="p">|</span> head -n 1<span class="k">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="o">[[</span> -z <span class="s2">&#34;</span><span class="nv">$expiration_date</span><span class="s2">&#34;</span> <span class="o">]]</span><span class="p">;</span> <span class="k">then</span>
</span></span><span class="line"><span class="cl">        <span class="nb">echo</span> <span class="s2">&#34;</span><span class="k">$(</span>date <span class="s1">&#39;+%Y-%m-%d %H:%M:%S&#39;</span><span class="k">)</span><span class="s2"> Error: Could not retrieve expiration date for </span><span class="nv">$domain</span><span class="s2">&#34;</span> <span class="p">|</span> tee -a <span class="s2">&#34;</span><span class="nv">$LOG_FILE</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="m">1</span>
</span></span><span class="line"><span class="cl">    <span class="k">fi</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># Преобразование даты в формат Unix timestamp</span>
</span></span><span class="line"><span class="cl">    <span class="nv">expiration_timestamp</span><span class="o">=</span><span class="k">$(</span>date -d <span class="s2">&#34;</span><span class="k">$(</span><span class="nb">echo</span> <span class="s2">&#34;</span><span class="nv">$expiration_date</span><span class="s2">&#34;</span> <span class="p">|</span> sed <span class="s1">&#39;s/\.[0-9]*Z//; s/T/ /&#39;</span><span class="k">)</span><span class="s2">&#34;</span> +%s 2&gt;&gt;<span class="s2">&#34;</span><span class="nv">$LOG_FILE</span><span class="s2">&#34;</span><span class="k">)</span>
</span></span><span class="line"><span class="cl">    <span class="nv">current_timestamp</span><span class="o">=</span><span class="k">$(</span>date +%s<span class="k">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># Вычисление количества дней до истечения</span>
</span></span><span class="line"><span class="cl">    <span class="nv">days_remaining</span><span class="o">=</span><span class="k">$((</span> <span class="o">(</span>expiration_timestamp <span class="o">-</span> current_timestamp<span class="o">)</span> <span class="o">/</span> <span class="m">86400</span> <span class="k">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># Отправка метрик в Pushgateway</span>
</span></span><span class="line"><span class="cl">    <span class="nv">metric_name</span><span class="o">=</span><span class="s2">&#34;domain_expiration_days&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="nv">push_url</span><span class="o">=</span><span class="s2">&#34;</span><span class="nv">$PUSHGATEWAY_URL</span><span class="s2">/metrics/job/domain_expiration/instance/</span><span class="nv">$domain</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="nv">metric_data</span><span class="o">=</span><span class="s2">&#34;</span><span class="nv">$metric_name</span><span class="s2">{domain=\&#34;</span><span class="nv">$domain</span><span class="s2">\&#34;} </span><span class="nv">$days_remaining</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nb">echo</span> <span class="s2">&#34;</span><span class="k">$(</span>date <span class="s1">&#39;+%Y-%m-%d %H:%M:%S&#39;</span><span class="k">)</span><span class="s2"> Pushing data for </span><span class="nv">$domain</span><span class="s2">: </span><span class="nv">$days_remaining</span><span class="s2"> days remaining&#34;</span> <span class="p">|</span> tee -a <span class="s2">&#34;</span><span class="nv">$LOG_FILE</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="nb">echo</span> <span class="s2">&#34;</span><span class="nv">$metric_data</span><span class="s2">&#34;</span> <span class="p">|</span> curl -X POST <span class="s2">&#34;</span><span class="nv">$push_url</span><span class="s2">&#34;</span> --data-binary @- 2&gt;&gt;<span class="s2">&#34;</span><span class="nv">$LOG_FILE</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Основной цикл</span>
</span></span><span class="line"><span class="cl"><span class="k">for</span> domain in <span class="s2">&#34;</span><span class="si">${</span><span class="nv">DOMAINS</span><span class="p">[@]</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">;</span> <span class="k">do</span>
</span></span><span class="line"><span class="cl">    <span class="nb">echo</span> <span class="s2">&#34;</span><span class="k">$(</span>date <span class="s1">&#39;+%Y-%m-%d %H:%M:%S&#39;</span><span class="k">)</span><span class="s2"> Processing domain: </span><span class="nv">$domain</span><span class="s2">&#34;</span> <span class="p">|</span> tee -a <span class="s2">&#34;</span><span class="nv">$LOG_FILE</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl">    process_domain <span class="s2">&#34;</span><span class="nv">$domain</span><span class="s2">&#34;</span> <span class="o">||</span> <span class="k">continue</span>  <span class="c1"># Пропуск домена в случае ошибки</span>
</span></span><span class="line"><span class="cl"><span class="k">done</span>
</span></span></code></pre></div><h3 id="файл-crontab-для-настройки-расписания-запуска-скрипта">Файл crontab для настройки расписания запуска скрипта:<a href="#%d1%84%d0%b0%d0%b9%d0%bb-crontab-%d0%b4%d0%bb%d1%8f-%d0%bd%d0%b0%d1%81%d1%82%d1%80%d0%be%d0%b9%d0%ba%d0%b8-%d1%80%d0%b0%d1%81%d0%bf%d0%b8%d1%81%d0%b0%d0%bd%d0%b8%d1%8f-%d0%b7%d0%b0%d0%bf%d1%83%d1%81%d0%ba%d0%b0-%d1%81%d0%ba%d1%80%d0%b8%d0%bf%d1%82%d0%b0" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h3>
<pre tabindex="0"><code># Запускать скрипт каждый день в 00:00
0 0 * * * /usr/local/bin/check_domains.sh &gt; /var/log/cron.log 2&gt;&amp;1
</code></pre><h3 id="файл-docker-composeyml">Файл docker-compose.yml<a href="#%d1%84%d0%b0%d0%b9%d0%bb-docker-composeyml" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">services:
</span></span><span class="line"><span class="cl">  pushgateway:
</span></span><span class="line"><span class="cl">    image: prom/pushgateway
</span></span><span class="line"><span class="cl">    container_name: pushgateway
</span></span><span class="line"><span class="cl">    network_mode: host
</span></span><span class="line"><span class="cl">    ports:
</span></span><span class="line"><span class="cl">      - <span class="s2">&#34;9091:9091&#34;</span> <span class="c1"># Порт Pushgateway</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  check-domains:
</span></span><span class="line"><span class="cl">    build:
</span></span><span class="line"><span class="cl">      context: .
</span></span><span class="line"><span class="cl">      dockerfile: Dockerfile
</span></span><span class="line"><span class="cl">    container_name: check-domains
</span></span><span class="line"><span class="cl">    hostname: check-domains
</span></span><span class="line"><span class="cl">    restart: always
</span></span><span class="line"><span class="cl">    environment:
</span></span><span class="line"><span class="cl">      - <span class="nv">PUSHGATEWAY_URL</span><span class="o">=</span>http://localhost:9091/metrics/job/domain_expiration
</span></span><span class="line"><span class="cl">    depends_on:
</span></span><span class="line"><span class="cl">      - pushgateway
</span></span><span class="line"><span class="cl">    network_mode: host
</span></span><span class="line"><span class="cl">    volumes:
</span></span><span class="line"><span class="cl">      - ./logs:/var/log <span class="c1"># Монтируем папку для логов</span>
</span></span></code></pre></div><h3 id="файл-dockerfile">Файл Dockerfile<a href="#%d1%84%d0%b0%d0%b9%d0%bb-dockerfile" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="c1"># Используем базовый образ Alpine Linux</span>
</span></span><span class="line"><span class="cl">FROM alpine:latest
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Устанавливаем необходимые пакеты</span>
</span></span><span class="line"><span class="cl">RUN apk add --no-cache <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    bash <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    curl <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    whois <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    dcron
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Копируем скрипт в контейнер</span>
</span></span><span class="line"><span class="cl">COPY check_domains.sh /usr/local/bin/check_domains.sh
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Делаем скрипт исполняемым</span>
</span></span><span class="line"><span class="cl">RUN chmod +x /usr/local/bin/check_domains.sh
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Копируем cron-задачу</span>
</span></span><span class="line"><span class="cl">COPY crontab /etc/cron.d/crontab
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Даем права на выполнение cron-задачи</span>
</span></span><span class="line"><span class="cl">RUN chmod <span class="m">0644</span> /etc/cron.d/crontab
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Создаем лог-файл для cron</span>
</span></span><span class="line"><span class="cl">RUN touch /var/log/cron.log
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Запускаем cron и логируем вывод</span>
</span></span><span class="line"><span class="cl">CMD touch /var/log/cron.log <span class="o">&amp;&amp;</span> crond <span class="o">&amp;&amp;</span> tail -f /var/log/cron.log
</span></span></code></pre></div><p>Настройка dashboard в Grafana:</p>
<ol>
<li>Добавляем Prometheus как источник данных.</li>
<li>Создаем панель с запросом:
<code>domain_expiration_days{domain=&quot;aaa.ru&quot;}</code></li>
<li>Настраиваем отображения данных в подходящем виде.</li>
</ol>
]]></content>
		</item>
		
		<item>
			<title>Настройка Vim</title>
			<link>https://shapkin.me/posts/customizing-vim/</link>
			<pubDate>Fri, 30 Jun 2023 13:12:24 +0300</pubDate><guid>https://shapkin.me/posts/customizing-vim/</guid>
			<description><![CDATA[&lt;no value&gt;]]></description><content type="text/html" mode="escaped"><![CDATA[<p>Когда мне надо отредактировать или просто просмотреть какой-либо файл на linux сервере я использую текстовой редактор vim.
Для удобства пользования, можно создать файл .vimrc в домашней директории пользователя и указать там нужные настройки.</p>
<p>За несколько лет использования редактора, я пришел к следующему набору:</p>
<ol>
<li><strong>expandtab</strong> —  Включает замену tab на пробелы</li>
<li><strong>smarttab</strong> — При нажатии tab в начале строки добавляется количество пробелов, указанное в директиве shiftwidth</li>
<li><strong>shiftwidth=4</strong> — Задает количество пробелов в одном tab</li>
<li><strong>tabstop=4</strong> — Задает количество пробелов в одном tab</li>
<li><strong>softtabstop=4</strong> — Задает количество пробелов в одном tab при удалении</li>
<li><strong>number</strong> — Добавляет нумерацию строк</li>
<li><strong>syntax on</strong> — Включает подсветку синтаксиса</li>
<li><strong>mouse=i</strong> — Включает режим вставки (мне обычно нужно для выделения курсором мышки и копирования строк)</li>
<li><strong>ignorecase и smartcase</strong> — Убирает чувствительность к регистру при поиске</li>
<li><strong>hlsearch</strong> — Включает подсветку результатов поиска</li>
<li><strong>incsearch</strong> — Подсветка первого вхождения по поиску</li>
<li><strong>encoding=utf8</strong> — Задает кодировку для работы с файлом</li>
</ol>
<p>Итак, чтобы добавить данные настройки пишем в консоли:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">cat &gt; ~/.vimrc <span class="s">&lt;&lt;EOF
</span></span></span><span class="line"><span class="cl"><span class="s">set expandtab
</span></span></span><span class="line"><span class="cl"><span class="s">set smarttab
</span></span></span><span class="line"><span class="cl"><span class="s">set tabstop=4
</span></span></span><span class="line"><span class="cl"><span class="s">set softtabstop=4
</span></span></span><span class="line"><span class="cl"><span class="s">set shiftwidth=4
</span></span></span><span class="line"><span class="cl"><span class="s">set number
</span></span></span><span class="line"><span class="cl"><span class="s">syntax on
</span></span></span><span class="line"><span class="cl"><span class="s">set mouse-=a
</span></span></span><span class="line"><span class="cl"><span class="s">set ignorecase
</span></span></span><span class="line"><span class="cl"><span class="s">set smartcase
</span></span></span><span class="line"><span class="cl"><span class="s">set hlsearch
</span></span></span><span class="line"><span class="cl"><span class="s">set incsearch
</span></span></span><span class="line"><span class="cl"><span class="s">set encoding=utf8
</span></span></span><span class="line"><span class="cl"><span class="s">EOF</span>
</span></span></code></pre></div><p>Осталось переподключить ssh сессию для применения настроек, либо воспользоваться командой source для применения настроек файла к текущей сессии.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="nb">source</span> .vimrc
</span></span></code></pre></div>]]></content>
		</item>
		
		<item>
			<title>Проблемы с дисковой производительностью на ESXi</title>
			<link>https://shapkin.me/posts/vmware-lsi-mr3/</link>
			<pubDate>Fri, 24 Mar 2023 11:16:33 +0300</pubDate><guid>https://shapkin.me/posts/vmware-lsi-mr3/</guid>
			<description><![CDATA[&lt;no value&gt;]]></description><content type="text/html" mode="escaped"><![CDATA[<p>Летом 2022 коллеги начали массово жаловаться на нестабильность работы стендов.
В процессе изучения была обнаружена проблема с производительностью дисковой подсистемы, которая проявляется только при большой нагрузке.</p>
<p>В логах на хостах были такие записи:</p>
<pre tabindex="0"><code>2022-06-27T17:37:29.743Z cpu1:36774)lsi_mr3: mfi_TaskMgmt:254: Processing taskMgmt virt reset for device: vmhba2:C2:T0:L0
2022-06-27T17:37:29.743Z cpu1:36774)lsi_mr3: mfi_TaskMgmt:258: VIRT_RESET cmd # 328727984
2022-06-27T17:37:29.743Z cpu1:36774)lsi_mr3: mfi_TaskMgmt:262: ABORT
</code></pre><p>Сразу уточню, что используется виртуализация VMware vSphere 6.</p>
<p>Версия драйвера который был установлен на моих ESXi хостах
<code>lsi-mr3 6.605.08.00-7vmw.600.1.17.3029758</code></p>
<p>Драйвер lsi_mr3 заполняет журналы ОС виртуальным сбросом (VIRT_RESET), ожиданиями ввода-вывода ( fusionWaitForOutstanding ).
ОС выдает виртуальные запросы на сброс (VRR) на локальные устройства хранения, что заставляет драйвер контроллера RAID прерывать все операции ввода-вывода,
а это в свою очередь может привести к отключению VMFS при большом количестве VRR.</p>
<p><code>Решается все установкой свежей версии драйвера, но возможно потребуется обновление прошивки RAID контроллера.</code></p>
<p>Ссылки по проблеме:</p>
<p><a href="https://kb.vmware.com/s/article/2151234" target="_blank">VMware KB</a></p>
<p><a href="https://support.lenovo.com/hk/ru/solutions/ht505543-vmware-local-datastore-disconnect-and-virtual-resets-on-the-logs-lenovo-thinksystem-and-lenovo-server" target="_blank">Support Lenovo</a></p>
]]></content>
		</item>
		
		<item>
			<title>Скрипт генерации клиентского конфига OpenVPN</title>
			<link>https://shapkin.me/posts/script-for-creating-new-openvpn-client/</link>
			<pubDate>Wed, 01 Mar 2023 12:52:01 +0300</pubDate><guid>https://shapkin.me/posts/script-for-creating-new-openvpn-client/</guid>
			<description><![CDATA[&lt;no value&gt;]]></description><content type="text/html" mode="escaped"><![CDATA[<p>Скрипт для упрощения генерации новых клиентов OpenVPN и создания готового inline конфига.</p>
<p>После установки и настройки openvpn сервера, создаем дополнительную директорию (если требуется), либо меняем путь на подходящий, куда будут сохраняться пользовательские конфигурации.</p>
<p>Создаем шаблон для клиентской конфигурации и сохраняем его, например в новую директорию /etc/openvpn/user_configs/</p>
<p>Указываем в файле необходимые директивы для работы сервиса, а также постоянные данные, например корневой сертификат и tls ключ.
При запуске скрипта указываем имя клиента, далее скрипт генерирует клиентский конфигурационный файл с уникальными данными и сохраняет его в указанную директорию с заданным именем.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="cp">#!/bin/sh
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="nb">read</span> -p <span class="s2">&#34;Enter client name: &#34;</span> clientname
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="o">[</span> -n <span class="s2">&#34;</span><span class="nv">$clientname</span><span class="s2">&#34;</span> <span class="o">]</span>
</span></span><span class="line"><span class="cl"><span class="k">then</span>
</span></span><span class="line"><span class="cl">	/etc/openvpn/easyrsa/easyrsa build-client-full <span class="nv">$clientname</span> nopass
</span></span><span class="line"><span class="cl">	cp /etc/openvpn/user_config.sample /etc/openvpn/user_configs/<span class="nv">$clientname</span>.ovpn
</span></span><span class="line"><span class="cl">	<span class="nb">echo</span> <span class="s2">&#34;&lt;cert&gt;\n</span><span class="k">$(</span>cat /etc/openvpn/easyrsa/pki/issued/<span class="nv">$clientname</span>.crt<span class="k">)</span><span class="s2">\n&lt;/cert&gt;&#34;</span> &gt;&gt; /etc/openvpn/user_configs/<span class="nv">$clientname</span>.ovpn
</span></span><span class="line"><span class="cl">	<span class="nb">echo</span> <span class="s2">&#34;&lt;key&gt;\n</span><span class="k">$(</span>cat /etc/openvpn/easyrsa/pki/private/<span class="nv">$clientname</span>.key<span class="k">)</span><span class="s2">\n&lt;/key&gt;&#34;</span> &gt;&gt; /etc/openvpn/user_configs/<span class="nv">$clientname</span>.ovpn
</span></span><span class="line"><span class="cl">	<span class="nb">echo</span> <span class="s2">&#34;+--------------------------------------------------------+&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="nb">echo</span> <span class="s2">&#34;|                                                        |&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="nb">echo</span> <span class="s2">&#34;| Find your new ovpn config in /etc/openvpn/user_configs |&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="nb">echo</span> <span class="s2">&#34;|                                                        |&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="nb">echo</span> <span class="s2">&#34;+--------------------------------------------------------+&#34;</span>
</span></span><span class="line"><span class="cl"><span class="k">else</span>
</span></span><span class="line"><span class="cl">	<span class="nb">echo</span> <span class="s2">&#34;Client name cannot be empty&#34;</span>
</span></span><span class="line"><span class="cl"><span class="k">fi</span>
</span></span></code></pre></div>]]></content>
		</item>
		
		<item>
			<title>VMware VCSA Certificates Expired</title>
			<link>https://shapkin.me/posts/vcsa-certificate-expired/</link>
			<pubDate>Mon, 24 Oct 2022 22:55:36 +0300</pubDate><guid>https://shapkin.me/posts/vcsa-certificate-expired/</guid>
			<description><![CDATA[&lt;no value&gt;]]></description><content type="text/html" mode="escaped"><![CDATA[<p>Внезапно VCSA 6.7 перестал авторизовывать, как доменного пользователя, так и локального администратора.
После перезагрузки в web интерфейсе постоянно висела 503 ошибка:</p>
<blockquote>
<p>503 Service Unavailable (Failed to connect to endpoint: [N7Vmacore4Http20NamedPipeServiceSpecE:0x00007f3d18008430] _serverNamespace = / action = Allow _pipeName =/var/run/vmware/vpxd-webserver-pipe)</p></blockquote>
<p>Первым делом иду в логи, а именно /var/log/vmware/vpxd/vpxd.log и нахожу там следующие строки:</p>
<pre tabindex="0"><code>2022-10-24T14:37:37.776Z error vpxd[04614] [Originator@6876 sub=vmomi.soapStub[6630]] Resetting stub adapter for server &lt;cs p:00007f9628783750, TCP:vcsa.domain.com:443&gt; : service state request failed: N7Vmacore3Ssl18SSLVerifyExceptionE(SSL Exception: Verification parameters:
--&gt; PeerThumbprint: BA:E3:25:18:AB:62:50:74:62:A9:19:CF:DB:1C:85:FF:FA:77:E7:5B
--&gt; ExpectedThumbprint: 
--&gt; ExpectedPeerName: vcsa.domain.com
--&gt; The remote host certificate has these problems:
--&gt; 
--&gt; * certificate has expired)
--&gt; [context]zKq7AVECAAAAAPb1/gANdnB4ZAAA4AArbGlidm1hY29yZS5zbwAAWCUbAP6dGACeQCIAaXEiABtFIgDTSSIAOaIjAHFvIwA6ciMAnVYrAdRzAGxpYnB0aHJlYWQuc28uMAACrY4ObGliYy5zby42AA==[/context]
</code></pre><p>Открываю браузер и проверяю информацию по сертификату, действительно срок действия истек:</p>
<pre tabindex="0"><code>Действителен с	Thu, 22 Oct 2020 16:17:37 GMT
Действителен по	Sun, 23 Oct 2022 04:17:37 GMT
</code></pre><p>Запускаем команду в shell (для linux версии) для получения списка сроков действия всех сертификатов:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="k">for</span> store in <span class="k">$(</span>/usr/lib/vmware-vmafd/bin/vecs-cli store list <span class="p">|</span> grep -v TRUSTED_ROOT_CRLS<span class="k">)</span><span class="p">;</span> <span class="k">do</span> <span class="nb">echo</span> <span class="s2">&#34;[*] Store :&#34;</span> <span class="nv">$store</span><span class="p">;</span> /usr/lib/vmware-vmafd/bin/vecs-cli entry list --store <span class="nv">$store</span> --text <span class="p">|</span> grep -ie <span class="s2">&#34;Alias&#34;</span> -ie <span class="s2">&#34;Not After&#34;</span><span class="p">;</span><span class="k">done</span><span class="p">;</span>
</span></span></code></pre></div><pre tabindex="0"><code>[*] Store : MACHINE_SSL_CERT
Alias :	__MACHINE_CERT
            Not After : Oct 23 04:17:37 2022 GMT
[*] Store : TRUSTED_ROOTS
Alias :	520b4889e71ea0ba9aa2fa5c9ca93131188bbcf5
            Not After : Oct 17 16:17:36 2030 GMT
[*] Store : machine
Alias :	machine
            Not After : Oct 22 16:08:37 2022 GMT
[*] Store : vsphere-webclient
Alias :	vsphere-webclient
            Not After : Oct 22 16:08:38 2022 GMT
[*] Store : vpxd
Alias :	vpxd
            Not After : Oct 22 16:08:39 2022 GMT
[*] Store : vpxd-extension
Alias :	vpxd-extension
            Not After : Oct 22 16:08:39 2022 GMT
[*] Store : APPLMGMT_PASSWORD
[*] Store : data-encipherment
Alias :	data-encipherment
            Not After : Oct 22 16:11:21 2022 GMT
[*] Store : SMS
Alias :	sms_self_signed
            Not After : Oct 22 16:24:58 2030 GMT
</code></pre><h3 id="решение-проблемы">Решение проблемы:<a href="#%d1%80%d0%b5%d1%88%d0%b5%d0%bd%d0%b8%d0%b5-%d0%bf%d1%80%d0%be%d0%b1%d0%bb%d0%b5%d0%bc%d1%8b" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h3>
<ul>
<li>запускаем менеджер сертификатов /usr/lib/vmware-vmca/bin/certificate-manager</li>
<li>выбираем нужный нам пункт</li>
<li>вводим логин от локального администратора (дефолтное значение будет указано в скобках)</li>
<li>вводим пароль от этого пользователя</li>
<li>далее отвечаем на вопросы для генерации нового сертификата</li>
<li>ждем выполнения процесса, пока не отобразится сообщение &ldquo;Status : 100% Completed [All tasks completed successfully]&rdquo;</li>
</ul>
<h3 id="источники">Источники:<a href="#%d0%b8%d1%81%d1%82%d0%be%d1%87%d0%bd%d0%b8%d0%ba%d0%b8" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h3>
<p><a href="https://kb.vmware.com/s/article/82332" target="_blank">https://kb.vmware.com/s/article/82332</a></p>
<p><a href="https://kb.vmware.com/s/article/2112283" target="_blank">https://kb.vmware.com/s/article/2112283</a></p>
]]></content>
		</item>
		
		<item>
			<title>Блокировка исходящего трафика в Windows</title>
			<link>https://shapkin.me/posts/block-traffic-by-powershell/</link>
			<pubDate>Mon, 12 Sep 2022 12:18:47 +0300</pubDate><guid>https://shapkin.me/posts/block-traffic-by-powershell/</guid>
			<description><![CDATA[&lt;no value&gt;]]></description><content type="text/html" mode="escaped"><![CDATA[<h2 id="задача">Задача:<a href="#%d0%b7%d0%b0%d0%b4%d0%b0%d1%87%d0%b0" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h2>
<p>Блокировать исходящий трафик, для тестирования функционала веб сервиса в браузере.</p>
<h2 id="решение">Решение:<a href="#%d1%80%d0%b5%d1%88%d0%b5%d0%bd%d0%b8%d0%b5" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h2>
<p>Блокировка исходящего трафика для браузера</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-powershell" data-lang="powershell"><span class="line"><span class="cl"><span class="nb">New-NetFirewallRule</span> <span class="n">-Program</span> <span class="s2">&#34;C:\Program Files (x86)\Internet Explorer\iexplore.exe&#34;</span> <span class="n">-Action</span> <span class="n">Block</span> <span class="n">-Profile</span> <span class="n">Any</span> <span class="n">-DisplayName</span> <span class="s2">&#34;block traffic&#34;</span> <span class="n">-RemoteAddress</span> <span class="n">Internet</span> <span class="n">-Direction</span> <span class="n">Outbound</span>
</span></span></code></pre></div><p>Блокировка всего исходящего трафика</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-powershell" data-lang="powershell"><span class="line"><span class="cl"><span class="nb">New-NetFirewallRule</span> <span class="n">-Action</span> <span class="n">Block</span> <span class="n">-Profile</span> <span class="n">Any</span> <span class="n">-DisplayName</span> <span class="s2">&#34;block traffic&#34;</span> <span class="n">-RemoteAddress</span> <span class="n">Internet</span> <span class="n">-Direction</span> <span class="n">Outbound</span>
</span></span></code></pre></div><p>Удаление правила</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-powershell" data-lang="powershell"><span class="line"><span class="cl"><span class="nb">Remove-NetFirewallRule</span> <span class="n">-DisplayName</span> <span class="s2">&#34;block traffic&#34;</span>
</span></span></code></pre></div><p>Включение и отключение правила</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-powershell" data-lang="powershell"><span class="line"><span class="cl"><span class="nb">Disable-NetFirewallRule</span> <span class="n">-DisplayName</span> <span class="s1">&#39;block traffic&#39;</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-powershell" data-lang="powershell"><span class="line"><span class="cl"><span class="nb">Enable-NetFirewallRule</span> <span class="n">-DisplayName</span> <span class="s1">&#39;block traffic&#39;</span>
</span></span></code></pre></div><p>Написал скрипт для удобства пользования</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-powershell" data-lang="powershell"><span class="line"><span class="cl"><span class="nb">Write-Host</span>
</span></span><span class="line"><span class="cl"><span class="nb">Write-Host</span> <span class="s2">&#34;Список доступных действий&#34;</span> <span class="n">-BackgroundColor</span> <span class="n">White</span> <span class="n">-ForegroundColor</span> <span class="n">Red</span>
</span></span><span class="line"><span class="cl"><span class="nb">Write-Host</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nb">Write-Host</span> <span class="s2">&#34;1. Создать блокирующее правило&#34;</span> <span class="n">-ForegroundColor</span> <span class="n">Green</span>
</span></span><span class="line"><span class="cl"><span class="nb">Write-Host</span> <span class="s2">&#34;2. Удалить блокирующее правило&#34;</span> <span class="n">-ForegroundColor</span> <span class="n">Green</span>
</span></span><span class="line"><span class="cl"><span class="nb">Write-Host</span> <span class="s2">&#34;3. Завершить&#34;</span> <span class="n">-ForegroundColor</span> <span class="n">Green</span>
</span></span><span class="line"><span class="cl"><span class="nb">Write-Host</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nv">$choice</span> <span class="p">=</span> <span class="nb">Read-Host</span> <span class="s2">&#34;Выберете пункт из списка&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">Switch</span><span class="p">(</span><span class="nv">$choice</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">  <span class="mf">1</span><span class="p">{</span><span class="nb">New-NetFirewallRule</span> <span class="n">-Action</span> <span class="n">Block</span> <span class="n">-Profile</span> <span class="n">Any</span> <span class="n">-DisplayName</span> <span class="s2">&#34;block traffic&#34;</span> <span class="n">-RemoteAddress</span> <span class="n">Internet</span> <span class="n">-Direction</span> <span class="n">Outbound</span><span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="mf">2</span><span class="p">{</span><span class="nb">Remove-NetFirewallRule</span> <span class="n">-DisplayName</span> <span class="s2">&#34;block traffic&#34;</span><span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="mf">3</span><span class="p">{</span><span class="nb">Write-Host</span> <span class="s2">&#34;Завершить&#34;</span><span class="p">;</span> <span class="n">exit</span><span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">default</span> <span class="p">{</span><span class="nb">Write-Host</span> <span class="s2">&#34;Некорректный ввод, попробуйте снова&#34;</span> <span class="n">-ForegroundColor</span> <span class="n">Red</span><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div>]]></content>
		</item>
		
		<item>
			<title>Отключение IPv6 в CentOS 8</title>
			<link>https://shapkin.me/posts/disable-ipv6-in-centos8/</link>
			<pubDate>Wed, 03 Feb 2021 17:44:25 +0300</pubDate><guid>https://shapkin.me/posts/disable-ipv6-in-centos8/</guid>
			<description><![CDATA[&lt;no value&gt;]]></description><content type="text/html" mode="escaped"><![CDATA[<p>Есть несколько способов по отключению ipv6 в linux, через ядро, через настройки сетевого интерфейса, я же предпочитаю отключать в загрузчике GRUB.</p>
<p>Открываем <code>/etc/default/grub</code> и добавляем новой строкой следующее:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-html" data-lang="html"><span class="line"><span class="cl">GRUB_CMDLINE_LINUX=&#34;$GRUB_CMDLINE_LINUX ipv6.disable=1&#34;
</span></span></code></pre></div><p>Сохраняем и закрываем файл.</p>
<p>Теперь следует обновить конфиг <code>grub.cfg</code>, выполняем команду  <code>ls -la /etc/grub*.cfg</code> и видим пути до 2х файлов:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-html" data-lang="html"><span class="line"><span class="cl">/boot/grub2/grub.cfg
</span></span><span class="line"><span class="cl">/boot/efi/EFI/centos/grub.cfg
</span></span></code></pre></div><p>Следующие 2 команды перегенерируют новые конфиги с учетом наших изменений:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-html" data-lang="html"><span class="line"><span class="cl">grub2-mkconfig -o /boot/grub2/grub.cfg
</span></span><span class="line"><span class="cl">grub2-mkconfig -o /boot/efi/EFI/centos/grub.cfg
</span></span></code></pre></div><p>Теперь остается перезагрузить наш сервер и проверить, что поддержка ipv6 действительно отключена для интерфейсов.</p>
<h3 id="ps">P.S.<a href="#ps" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h3>
<p>На этапе перегенерации конфигов я столкнулся с такой ошибкой:
<img src="/img/006/006-1.png" alt=""></p>
<p>Для решения было достаточно пересоздать grubenv командой <code>grub2-editenv create</code></p>
<p><img src="/img/006/006-2.png" alt=""></p>
<p>Отмечу, что все действия производились на свежеустановленной ОС.</p>
]]></content>
		</item>
		
		<item>
			<title>Openvpn Certificate Verify Failed</title>
			<link>https://shapkin.me/posts/openvpn-certificate-verify-failed/</link>
			<pubDate>Mon, 25 Jan 2021 16:39:22 +0300</pubDate><guid>https://shapkin.me/posts/openvpn-certificate-verify-failed/</guid>
			<description><![CDATA[&lt;no value&gt;]]></description><content type="text/html" mode="escaped"><![CDATA[<p>Столкнулся с проблемой, удаленные клиенты не могут подключиться по OpenVPN.</p>
<p>В логе openvpn.log обнаружил следующее:</p>
<pre tabindex="0"><code>    WARNING: Failed to stat CRL file, not (re)loading CRL.
    VERIFY ERROR: depth=0, error=CRL has expired: CN=client, serial=292462498369187844598607062130070224235
    OpenSSL: error:1417C086:SSL routines:tls_process_client_certificate:certificate verify failed
    TLS_ERROR: BIO read tls_read_plaintext error
    TLS Error: TLS object -&gt; incoming plaintext read error
    TLS Error: TLS handshake failed
    Fatal TLS error (check_tls_errors_co), restarting
</code></pre><p>Ключевое, на что нужно обратить внимание, это <code>WARNING: Failed to stat CRL file, not (re)loading CRL.</code></p>
<p>Заходим в директорию с easyrsa и там выполняем команду:</p>
<p><code>openssl crl -inform PEM -in pki/crl.pem -text -noout</code></p>
<p>Проверяем дату действия списка отозванных сертификатов, в моем случае он закончился сутки назад:</p>
<pre tabindex="0"><code>	Last Update: Jul 28 21:28:59 2020 GMT
	Next Update: Jan 24 21:28:59 2021 GMT
</code></pre><p>Это значит, что прошло 180 дней с момента последнего запуска по генерации списка отозванных сертификатов и срок действия его - как раз 180 дней.</p>
<p>Чтобы исправить ситуацию, необходимо выполнить команду</p>
<pre><code>./easyrsa gen-crl
</code></pre>
<p>и скопировать новый crl.pem по пути, который указан в Вашем опенвпн сервер конфиге.
Но я решил также и увеличить срок действия списка до 720 дней, для этого нужно открыть файл vars и увеличить значение для <code>EASYRSA_CRL_DAYS</code>.
Проверяем:</p>
<p><code>openssl crl -inform PEM -in pki/crl.pem -text -noout</code></p>
<pre><code>Last Update: Jan 25 10:30:58 2021 GMT
Next Update: Jan 15 10:30:58 2023 GMT
</code></pre>
]]></content>
		</item>
		
		<item>
			<title>Обновление и миграция Redmine между двумя серверами</title>
			<link>https://shapkin.me/posts/redmine-update-and-migrate/</link>
			<pubDate>Tue, 08 Dec 2020 19:41:15 +0300</pubDate><guid>https://shapkin.me/posts/redmine-update-and-migrate/</guid>
			<description><![CDATA[&lt;no value&gt;]]></description><content type="text/html" mode="escaped"><![CDATA[<p>Пришла пора обновить redmine с 3.4* версии до последней стабильной 4.1.1, при этом с переносом на другой сервер.</p>
<h3 id="старый-сервер-с-redmine">Старый сервер с Redmine<a href="#%d1%81%d1%82%d0%b0%d1%80%d1%8b%d0%b9-%d1%81%d0%b5%d1%80%d0%b2%d0%b5%d1%80-%d1%81-redmine" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h3>
<ul>
<li>CentOS 7</li>
<li>mysql 5.5</li>
<li>ruby 2.0 / rail 4.2</li>
<li>thin (gem сервер приложения)</li>
</ul>
<h3 id="новый-сервер-с-redmine">Новый сервер с Redmine<a href="#%d0%bd%d0%be%d0%b2%d1%8b%d0%b9-%d1%81%d0%b5%d1%80%d0%b2%d0%b5%d1%80-%d1%81-redmine" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h3>
<ul>
<li>CentOS 8</li>
<li>mariadb 10</li>
<li>ruby 2.6.5 / rails 5.2</li>
<li>thin (gem сервер приложения)</li>
</ul>
<p>Ниже опишу шаги, которые необходимо произвести, чтобы миграция прошла без проблем (в моем случае отработало без ошибок).</p>
<ol>
<li>Установка нужной версии Redmine по инструкциям с сайта <a href="https://redmine.org/" target="_blank">https://redmine.org/</a></li>
<li>На старом redmine я отключаю все задачи cron для сервиса, в том числе и для получения почты (Подробнее о настройке по ссылке)</li>
<li>Останавливаю сервис thin systemctl stop thin</li>
<li>Удаляю установленные плагины, точнее чистим записи в базе, если для установки плагина требуется миграция (Подробнее про удаление по ссылке)</li>
<li>Далее снимаем дамп с БД mysqldump -u root -p redmine &gt; redmine.sql (В моем случае используется mysql)</li>
<li>Переносим на новый сервер scp redmine.sql <a href="mailto:root@192.168.1.1">root@192.168.1.1</a>:/tmp</li>
<li>Теперь выполняем команды на новом сервер cp /tmp/redmine.sql /path/to/redmine/</li>
<li>Восстанавливаем дамп mysql -u root -p redmine &lt; redmine.sql</li>
<li>Теперь обязательный пункт, это совершить миграцию базы, чтобы применились изменения, иначе будет ошибка 500 при переходе в проекты rake db:migrate RAILS_ENV=production</li>
<li>Дополнительно перезапускаем сервис thin</li>
<li>Устанавливаем плагины</li>
<li>Перенастраиваем адреса для проксирования, если есть пограничный сервер (в моем случае в роли обратного прокси выступает nginx)</li>
</ol>
]]></content>
		</item>
		
	</channel>
</rss>
